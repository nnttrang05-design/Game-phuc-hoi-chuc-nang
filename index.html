<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá Th·ªëng Ph·ª•c H·ªìi Ch·ª©c NƒÉng B√†n Tay - BME</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    
    <style>
        :root {
            --primary: #00e5ff;
            --success: #00e676;
            --danger: #ff1744;
            --panel-bg: rgba(20, 25, 35, 0.95);
        }

        body {
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden;
        }

        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; z-index: 1000;
            justify-content: center; align-items: center;
        }

        .login-box {
            background: var(--panel-bg); padding: 50px; border-radius: 25px;
            border: 2px solid var(--primary); text-align: center;
            box-shadow: 0 0 50px rgba(0, 229, 255, 0.3);
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }

        .login-box input {
            padding: 15px; width: 300px; border-radius: 10px; border: none;
            margin: 10px 0; font-size: 18px; text-align: center;
        }

        .header {
            color: var(--primary); font-size: 30px; font-weight: 800;
            margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px;
        }

        .game-wrapper {
            position: relative; width: 1100px; height: 650px; display: flex; gap: 25px;
        }

        .game-area {
            position: relative; flex: 2.5; background: #000;
            border-radius: 25px; border: 2px solid rgba(0, 229, 255, 0.2);
            overflow: hidden;
        }

        canvas { width: 100%; height: 100%; transform: scaleX(-1); object-fit: cover; }

        .sidebar { flex: 1; display: flex; flex-direction: column; gap: 20px; }

        .metric-card {
            background: var(--panel-bg); padding: 25px; border-radius: 20px;
            border-left: 6px solid var(--primary);
        }

        .metric-label { font-size: 14px; color: #a0aec0; text-transform: uppercase; font-weight: bold; }
        .metric-value { font-size: 45px; font-weight: 800; font-family: monospace; margin-top: 10px; }

        #resultModal {
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95); z-index: 100;
            flex-direction: column; align-items: center; justify-content: center; border-radius: 25px;
        }

        .status-ok { color: var(--success); font-size: 32px; font-weight: bold; }
        .status-warn { color: var(--danger); font-size: 32px; font-weight: bold; }

        .btn {
            background: linear-gradient(135deg, #00e5ff, #0083b0);
            color: white; border: none; padding: 18px 40px; border-radius: 12px;
            font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.3s;
            width: 100%; max-width: 330px;
        }
        .btn:hover { transform: translateY(-3px); }
        .btn-secondary { background: linear-gradient(135deg, #4b6cb7, #182848); }
        .btn-danger { background: linear-gradient(135deg, #ff1744, #d50000); }

        .input_video { display: none; }
        
        #handStatusIndicator {
            position: absolute; top: 20px; left: 20px; padding: 10px 20px;
            border-radius: 50px; font-weight: bold; font-size: 18px;
            background: rgba(0,0,0,0.6); z-index: 10;
        }

        /* Styles cho L·ªãch s·ª≠ Modal */
        #historyModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .history-content {
            background: var(--panel-bg); padding: 40px; border-radius: 20px;
            border: 2px solid #4b6cb7; width: 85%; max-height: 85vh; overflow-y: auto;
        }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; text-align: center; }
        .history-table th { padding: 15px; border-bottom: 2px solid #4b6cb7; color: #a0aec0; position: sticky; top: 0; background: var(--panel-bg); }
        .history-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .history-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h1 style="color: var(--primary); margin: 0;">BME MEDICAL</h1>
            <input type="text" id="patientName" placeholder="T√™n b·ªánh nh√¢n..." autocomplete="off">
            <button class="btn" onclick="startApp()">B·∫ÆT ƒê·∫¶U</button>
            <button class="btn btn-secondary" onclick="showHistory()">XEM L·ªäCH S·ª¨</button>
        </div>
    </div>

    <div id="historyModal">
        <div class="history-content">
            <h2 style="color: #4b6cb7; text-align: center; margin-top: 0; font-size: 28px;">L·ªäCH S·ª¨ PH·ª§C H·ªíI CH·ª®C NƒÇNG</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>B·ªánh nh√¢n</th>
                        <th>ƒêi·ªÉm s·ªë</th>
                        <th>G√≥c g·∫≠p TB</th>
                        <th>ƒê·ªô rung TB</th>
                        <th>ƒê√°nh gi√° l√¢m s√†ng</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
            <div class="history-actions">
                <button class="btn" onclick="closeHistory()" style="width: auto;">ƒê√ìNG</button>
                <button class="btn btn-danger" onclick="clearHistory()" style="width: auto;">X√ìA D·ªÆ LI·ªÜU</button>
            </div>
        </div>
    </div>

    <div class="header">LUY·ªÜN T·∫¨P V·∫¨N ƒê·ªòNG B√ÄN TAY</div>

    <div class="game-wrapper">
        <video class="input_video"></video>
        
        <div class="game-area">
            <div id="handStatusIndicator">ƒêANG CH·ªú...</div>
            <canvas class="output_canvas" width="800" height="600"></canvas>
            
            <div id="resultModal">
                <h2 style="font-size: 40px;">HO√ÄN TH√ÄNH!</h2>
                <div id="statusOutput" style="margin-bottom: 40px; text-align: center;"></div>
                <button class="btn" onclick="location.reload()">üîÑ TH·ª∞C HI·ªÜN L·∫†I</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="metric-card" style="border-color: var(--danger);">
                <div class="metric-label">‚è± Th·ªùi gian c√≤n l·∫°i</div>
                <div class="metric-value" id="timerText" style="color: var(--danger);">60s</div>
            </div>

            <div class="metric-card" style="border-color: #ffd700;">
                <div class="metric-label">üí∞ T·ªïng ti·ªÅn thu th·∫≠p</div>
                <div class="metric-value" id="score" style="color: #ffd700;">0</div>
            </div>

            <div class="metric-card" style="margin-top: auto; border-color: #888;">
                <div class="metric-label">üë§ B·ªánh nh√¢n</div>
                <div id="displayName" style="font-size: 22px; font-weight: bold; margin-top: 5px;">---</div>
            </div>
        </div>
    </div>

    <script>
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const handStatusDiv = document.getElementById('handStatusIndicator');
        
        let score = 0, timeLeft = 60, isPlaying = false, patientName = "";
        let moneys = [], patientDataLog = [], pathHistory = [], gameTimer = null;
        let hasOpenedHand = false; 

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function startApp() {
            patientName = document.getElementById('patientName').value.trim();
            if (!patientName) { alert("Vui l√≤ng nh·∫≠p t√™n b·ªánh nh√¢n!"); return; }
            document.getElementById('displayName').innerText = patientName;
            document.getElementById('loginOverlay').style.display = 'none';
            initCamera();
        }

        // --- C√ÅC H√ÄM X·ª¨ L√ù L·ªäCH S·ª¨ ---
        function saveSessionData(avgA, avgT, diagMsg) {
            let history = JSON.parse(localStorage.getItem('bme_patient_history')) || [];
            let session = {
                date: new Date().toLocaleString('vi-VN'),
                name: patientName,
                score: score,
                avgAngle: avgA.toFixed(1),
                avgTremor: avgT.toFixed(1),
                diagnosis: diagMsg
            };
            history.push(session);
            localStorage.setItem('bme_patient_history', JSON.stringify(history));
        }

        function showHistory() {
            document.getElementById('historyModal').style.display = 'flex';
            let history = JSON.parse(localStorage.getItem('bme_patient_history')) || [];
            let tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 30px; color: #888;">Ch∆∞a c√≥ d·ªØ li·ªáu y √°n n√†o ƒë∆∞·ª£c ghi nh·∫≠n tr√™n thi·∫øt b·ªã n√†y.</td></tr>';
                return;
            }
            
            // Hi·ªÉn th·ªã d·ªØ li·ªáu m·ªõi nh·∫•t l√™n ƒë·∫ßu
            history.slice().reverse().forEach(record => {
                let diagColor = record.diagnosis.includes("B·∫§T TH∆Ø·ªúNG") ? "var(--danger)" : "var(--success)";
                tbody.innerHTML += `
                    <tr>
                        <td>${record.date}</td>
                        <td style="font-weight: bold;">${record.name}</td>
                        <td style="color: #ffd700; font-family: monospace; font-size: 18px;">${record.score}</td>
                        <td>${record.avgAngle}¬∞</td>
                        <td>${record.avgTremor}</td>
                        <td style="color: ${diagColor}; font-weight: bold;">${record.diagnosis.replace('PH√ÅT HI·ªÜN B·∫§T TH∆Ø·ªúNG: ', '')}</td>
                    </tr>
                `;
            });
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function clearHistory() {
            if (confirm("C·∫£nh b√°o: Thao t√°c n√†y s·∫Ω x√≥a to√†n b·ªô l·ªãch s·ª≠ b·ªánh √°n tr√™n tr√¨nh duy·ªát hi·ªán t·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?")) {
                localStorage.removeItem('bme_patient_history');
                showHistory(); // Refresh b·∫£ng
            }
        }
        // -----------------------------

        function playSound(f, d) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        function calculateAngle(A, B, C) {
            const v1 = { x: A.x - B.x, y: A.y - B.y }, v2 = { x: C.x - B.x, y: C.y - B.y };
            const dot = v1.x * v2.x + v1.y * v2.y;
            const mag1 = Math.sqrt(v1.x**2 + v1.y**2), mag2 = Math.sqrt(v2.x**2 + v2.y**2);
            return (Math.acos(dot / (mag1 * mag2)) * 180 / Math.PI).toFixed(1);
        }

        function onResults(results) {
            if (!isPlaying) return;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            let isGrip = false, hx = 0, hy = 0, avgAngle = 0, tremor = 0;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                
                const thumb = calculateAngle(lm[1], lm[2], lm[4]);
                const index = calculateAngle(lm[5], lm[6], lm[8]);
                const middle = calculateAngle(lm[9], lm[10], lm[12]);
                const ring = calculateAngle(lm[13], lm[14], lm[16]);
                const pinky = calculateAngle(lm[17], lm[18], lm[20]);
                avgAngle = (parseFloat(thumb) + parseFloat(index) + parseFloat(middle) + parseFloat(ring) + parseFloat(pinky)) / 5;

                if (avgAngle > 150) { 
                    hasOpenedHand = true; 
                    handStatusDiv.innerText = "‚úã ƒê√É X√íE 5 NG√ìN - S·∫¥N S√ÄNG B·∫ÆT";
                    handStatusDiv.style.color = "#00e676";
                }
                
                isGrip = avgAngle < 100;

                if (!hasOpenedHand) {
                    handStatusDiv.innerText = "‚úä H√ÉY X√íE C·∫¢ 5 NG√ìN TAY";
                    handStatusDiv.style.color = "#ff1744";
                }

                let handColor = hasOpenedHand ? (isGrip ? '#ffd700' : '#00e676') : '#ff1744';
                drawConnectors(canvasCtx, lm, HAND_CONNECTIONS, { color: handColor, lineWidth: 5 });
                drawLandmarks(canvasCtx, lm, { color: '#ffffff', lineWidth: 1, radius: 2 });
                
                hx = lm[9].x * canvasElement.width;
                hy = lm[9].y * canvasElement.height;
                
                pathHistory.push({x: hx, y: hy});
                if (pathHistory.length > 15) pathHistory.shift();
                if (pathHistory.length === 15) {
                    let path = 0;
                    for(let i=1; i<15; i++) path += Math.hypot(pathHistory[i].x-pathHistory[i-1].x, pathHistory[i].y-pathHistory[i-1].y);
                    tremor = (path - Math.hypot(pathHistory[14].x-pathHistory[0].x, pathHistory[14].y-pathHistory[0].y)).toFixed(1);
                }
            }

            if (Math.random() < 0.035) {
                moneys.push({ 
                    x: Math.random() * 700 + 50, 
                    y: -50, 
                    speed: 3.5 + Math.random() * 2.5 
                });
            }

            canvasCtx.scale(-1, 1);
            canvasCtx.font = "50px Arial";
            for (let i = moneys.length - 1; i >= 0; i--) {
                let m = moneys[i]; m.y += m.speed;
                canvasCtx.fillText("üí∞", -m.x, m.y);

                if (hx !== 0) {
                    let dist = Math.hypot(hx - m.x, hy - m.y);
                    if (dist < 80 && isGrip && hasOpenedHand) {
                        playSound(880, 0.1); 
                        score += 10000;
                        document.getElementById('score').innerText = score.toLocaleString();
                        patientDataLog.push({ time: (60 - timeLeft), ang: avgAngle, trem: tremor, currentScore: score });
                        
                        moneys.splice(i, 1);
                        hasOpenedHand = false; 
                        continue;
                    }
                }
                if (m.y > 650) moneys.splice(i, 1);
            }
            canvasCtx.restore();
        }

        function initCamera() {
            const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.75, minTrackingConfidence: 0.75 });
            hands.onResults(onResults);
            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 800, height: 600
            });
            camera.start().then(() => {
                isPlaying = true;
                gameTimer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('timerText').innerText = timeLeft + "s";
                    if(timeLeft <= 0) endGame();
                }, 1000);
            });
        }

        function endGame() {
            isPlaying = false; clearInterval(gameTimer);
            playSound(440, 0.5);
            document.getElementById('resultModal').style.display = 'flex';

            let avgA = 0, avgT = 0, maxT = 0;
            if (patientDataLog.length > 0) {
                let sA = 0, sT = 0;
                patientDataLog.forEach(d => {
                    sA += parseFloat(d.ang); sT += parseFloat(d.trem);
                    if (parseFloat(d.trem) > maxT) maxT = parseFloat(d.trem);
                });
                avgA = sA / patientDataLog.length; avgT = sT / patientDataLog.length;
            }

            let issues = [];
            if (avgA > 95) issues.push("H·∫°n ch·∫ø t·∫ßm v·∫≠n ƒë·ªông");
            if (avgT > 12 || maxT > 25) issues.push("R·ªëi lo·∫°n ki·ªÉm so√°t c∆° (D·∫•u hi·ªáu run)");

            const diagMsg = issues.length === 0 ? "B√¨nh th∆∞·ªùng" : "PH√ÅT HI·ªÜN B·∫§T TH∆Ø·ªúNG: " + issues.join(" | ");
            document.getElementById('statusOutput').innerHTML = issues.length === 0 ? 
                `<div class="status-ok">K·∫æT LU·∫¨N: TAY HO·∫†T ƒê·ªòNG ·ªîN ƒê·ªäNH</div>` : `<div class="status-warn">K·∫æT LU·∫¨N: C·∫¶N CH√ö √ù V·∫¨N ƒê·ªòNG</div>`;

            // L∆∞u d·ªØ li·ªáu v√†o Local Storage
            saveSessionData(avgA, avgT, diagMsg);

            exportCSV(avgA, avgT, maxT, diagMsg);
        }

        function exportCSV(avgA, avgT, maxT, diag) {
            let csv = "data:text/csv;charset=utf-8,\uFEFF";
            csv += `B√ÅO C√ÅO PH·ª§C H·ªíI CH·ª®C NƒÇNG\nB·ªánh nh√¢n: ${patientName}\n\n`;
            csv += "Th·ªùi ƒëi·ªÉm (Gi√¢y),ƒêi·ªÉm s·ªë,G√≥c g·∫≠p trung b√¨nh (5 ng√≥n),ƒê·ªô rung (Tremor)\n";
            patientDataLog.forEach(d => { csv += `${d.time},${d.currentScore},${d.ang.toFixed(1)},${d.trem}\n`; });
            
            csv += "\n=== B·∫¢NG T·ªîNG K·∫æT V√Ä ƒê√ÅNH GI√Å Y KHOA ===,,,\n";
            csv += `T·ªïng s·ªë l·∫ßn v·∫≠n ƒë·ªông:,${patientDataLog.length} l·∫ßn,,\n`;
            csv += `G√≥c g·∫≠p trung b√¨nh:,${avgA.toFixed(1)}¬∞,,\n`;
            csv += `ƒê·ªô rung tay trung b√¨nh:,${avgT.toFixed(1)},,\n`;
            csv += `ƒê·ªô rung tay gi·∫≠t m·∫°nh nh·∫•t:,${maxT.toFixed(1)},,\n`;
            csv += ` K·∫æT LU·∫¨N:,${diag},,\n`;

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", `BaoCao_${patientName}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
    </script>
</body>
</html>
